<div id="i-doit-objectbrowser" style="position: relative; min-width: 400px;">
    <div id="data-store" style="display:none;"></div>
	<div id="i-doit-browser-notice" class="ui-corner-all"></div>
    <div id="i-doit-objectbrowser-content" style="display:none;">
        <a href="<% RT->Config->Get('IDoitURL') %>" title="Go to i-doit" target="_blank">
			<img src="<% RT->Config->Get('WebPath') %>/NoAuth/images/i-doit.png" alt="i-doit" style="position: absolute; top: 5px; right: 8px; height: 28px;" />
		</a>

        <img id="loading-screen" src="<% RT->Config->Get('WebPath') %>/NoAuth/images/ajaxload.gif" alt="Loading" height="32" width="32" style="position: absolute; opacity: 0; z-index: 100; right: 80px; top: 5px;" />

		Ausgewählte Objekte
		<table class="object-table" style="width:100%;">
			<thead>
				<tr>
					<th width="10%">ID</th>
					<th width="50%">Name</th>
					<th width="40%">Typ</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
    </div>
</div>

<script type="text/javascript">
	// Global variables (without "var").
    idoit_url = '<% $IDoitURL %>';

	api_url = '<% $IDoitAPI %>';
	api_lang = '<% $IDoitLanguage %>';
	api_user = '<% $IDoitUser %>';
	api_password = '<% $IDoitPassword %>';
	api_mandator = 0;

	show_custom_fields = <% $IDoitShowCustomFields %>;

	browser_preselection_field = 'tr#<% $IDoitObjects %>';
	browser_mandator_field = 'tr#<% $IDoitMandator %>';
</script>

<script type="text/javascript" src="<% RT->Config->Get('WebPath') %>/NoAuth/js/i-doit-objectbrowser.js"></script>

<script type="text/javascript">
	(function($) {
		browser_preselection_field = $(browser_preselection_field);
		browser_mandator_field = $(browser_mandator_field);
		
		$.each(browser_preselection_field.find('ul li'), function(i, e) {
			console.log('---');
			console.log(i);
			console.log(e);
			preselection[] = $(e).text();
		});

		data = {
			"method":"cmdb.objects",
			"params":{
				"session":{
					"username":api_user,
					"password":api_password,
					"language":api_lang,
					"mandator":api_mandator},
				"filter":{
					"ids":preselection}},
			"id":"1",
			"jsonrpc":"2.0"};

		idoit_ajax(data, function(response) {
				if (response.error == null) {
					$.each(response.result, function(i, e) {
						$('#i-doit-content').append('<br />' + e.title + ' (' + e.id + ')');
					});
				} else {
					window.error_notice(objectbrowser_lang.LC_ERR_LOADING_OBJECTS_BY_PRESELECTION);
				}
			});

		// Hide custom fields:
		if (show_custom_fields == 0) {
			browser_preselection_field.parent().parent().hide();
			browser_mandator_field.parent().parent().hide();
		}

		// Start the browser.
		window.init_browser();
	})(jQuery);
</script>

<%INIT>
use Switch;

$IDoitURL = RT->Config->Get('IDoitURL');
unless($IDoitURL) {
    my $msg = loc('URL for i-doit is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitAPI = RT->Config->Get('IDoitAPI');
unless($IDoitAPI) {
    my $msg = loc('URL for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitLanguage = RT->Config->Get('IDoitLanguage');
unless($IDoitLanguage) {
    my $msg = loc('Language for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitUser = RT->Config->Get('IDoitUser');
unless($IDoitUser) {
    my $msg = loc('User for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

$IDoitPassword = RT->Config->Get('IDoitPassword');
unless($IDoitPassword) {
    my $msg = loc('Password for i-doit\'s API is not configured.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}

my $cfMandator = 'i-doit mandator';
my $cf = RT::CustomField->new($RT::SystemUser);
$cf->LoadByNameAndQueue(Name => $cfMandator, Queue => '0');
unless($cf->id) {
    my $msg = loc('Custom field "' . $cfMandator . '" does not exist.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}
$IDoitMandator = 'CF-' . $cf->id . '-ShowRow';

my $cfObjects = 'i-doit objects';
$cf = RT::CustomField->new($RT::SystemUser);
$cf->LoadByNameAndQueue(Name => $cfObjects, Queue => '0');
unless($cf->id) {
    my $msg = loc('Custom field "' . $cfObjects . '" does not exist.');
    RT::Logger->error($msg);
    $$skip_create = 1;
    push @{$results}, $msg;
}
$IDoitObjects = 'CF-' . $cf->id . '-ShowRow';

$IDoitShowCustomFields = RT->Config->Get('IDoitShowCustomFields');
</%INIT>

<%ARGS>
$skip_create => undef
$results => undef

$IDoitURL => undef
$IDoitAPI => undef
$IDoitLanguage => undef
$IDoitUser => undef
$IDoitPassword => undef
$IDoitMandator => undef
$IDoitObjects => undef
$IDoitView => undef
$IDoitShowCustomFields => undef
</%ARGS>
